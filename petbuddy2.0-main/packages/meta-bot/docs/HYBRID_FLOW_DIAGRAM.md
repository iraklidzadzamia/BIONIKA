# Hybrid AI Flow Diagram

## Complete Message Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER SENDS MESSAGE                            â”‚
â”‚             "Hello!" or "Book appointment"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   WEBHOOK RECEIVED                               â”‚
â”‚        Facebook/Instagram â†’ Meta-Bot Server                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 COMPANY LOOKUP                                   â”‚
â”‚    Get company settings: ai_provider, system_instructions        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               CHECK AI PROVIDER                                  â”‚
â”‚                                                                  â”‚
â”‚   ai_provider = "gemini" OR USE_GEMINI=true?                    â”‚
â”‚                                                                  â”‚
â”‚          YES â†“                           NO â†“                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚    â”‚ USE GEMINI   â”‚              â”‚ USE OPENAI   â”‚              â”‚
â”‚    â”‚ (Hybrid)     â”‚              â”‚ (Traditional)â”‚              â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                             â”‚
            â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GEMINI AGENT NODE          â”‚           â”‚   OPENAI AGENT NODE          â”‚
â”‚                              â”‚           â”‚                              â”‚
â”‚ 1. Load conversation history â”‚           â”‚ 1. Load conversation history â”‚
â”‚ 2. Prune to 15 messages      â”‚           â”‚ 2. Prune to 15 messages      â”‚
â”‚ 3. Add system instructions   â”‚           â”‚ 3. Add system instructions   â”‚
â”‚ 4. Call Gemini 1.5 Flash/Pro â”‚           â”‚ 4. Call OpenAI GPT-4o        â”‚
â”‚ 5. Get response              â”‚           â”‚ 5. Get response              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                          â”‚
               â”‚ Gemini Response                          â”‚ OpenAI Response
               â”‚                                          â”‚
               â–¼                                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Check Response Type  â”‚                  â”‚ Check Response Type  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                          â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚                        â”‚                â”‚
       â–¼                â–¼                        â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEXT ONLY   â”‚  â”‚ TOOL CALLS  â”‚        â”‚ TEXT ONLY   â”‚  â”‚ TOOL CALLS  â”‚
â”‚ (70-80%)    â”‚  â”‚ (20-30%)    â”‚        â”‚             â”‚  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                       â”‚                â”‚
       â”‚                â”‚                       â”‚                â”‚
       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                â”‚
       â”‚         â”‚ SWITCH TO       â”‚            â”‚                â”‚
       â”‚         â”‚ OPENAI!         â”‚            â”‚                â”‚
       â”‚         â”‚                 â”‚            â”‚                â”‚
       â”‚         â”‚ Reason: Tools   â”‚            â”‚                â”‚
       â”‚         â”‚ need reliable   â”‚            â”‚                â”‚
       â”‚         â”‚ execution       â”‚            â”‚                â”‚
       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                â”‚
       â”‚                  â”‚                     â”‚                â”‚
       â”‚                  â–¼                     â”‚                â”‚
       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                â”‚
       â”‚         â”‚ OpenAI Agent     â”‚           â”‚                â”‚
       â”‚         â”‚ with Tools       â”‚           â”‚                â”‚
       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                â”‚
       â”‚                  â”‚                     â”‚                â”‚
       â”‚                  â–¼                     â”‚                â”‚
       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                â”‚
       â”‚         â”‚ Execute Tools    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚         â”‚ (book, cancel,   â”‚           â”‚                â”‚
       â”‚         â”‚  get_times, etc) â”‚           â”‚                â”‚
       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                â”‚
       â”‚                  â”‚                     â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SEND RESPONSE                                  â”‚
â”‚         "Hi there!" or "Booked for Jan 5 at 2pm"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TRACK METRICS                                   â”‚
â”‚                                                                  â”‚
â”‚  Provider: gemini | openai | gemini-to-openai-switch            â”‚
â”‚  Execution Time: 500ms                                           â”‚
â”‚  Cost: $0.0001 (Gemini) or $0.005 (OpenAI)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Decision Matrix

### When Gemini is Enabled (USE_GEMINI=true)

| Message Type | First Handler | Final Handler | Why? |
|-------------|---------------|---------------|------|
| "Hello!" | Gemini | **Gemini** | Text only, no tools needed |
| "What are your hours?" | Gemini | **Gemini** | Simple question, no tools |
| "Thanks!" | Gemini | **Gemini** | Acknowledgment, no tools |
| "Book appointment tomorrow" | Gemini | **OpenAI** | Detected tool call â†’ switch |
| "Show my bookings" | Gemini | **OpenAI** | Detected tool call â†’ switch |
| "Cancel my appointment" | Gemini | **OpenAI** | Detected tool call â†’ switch |

### When Gemini is Disabled (USE_GEMINI=false)

| Message Type | Handler | Why? |
|-------------|---------|------|
| All messages | **OpenAI** | Single provider mode |

## Cost Breakdown by Flow

### Flow 1: Text-Only Response (Gemini)

```
User: "Hello, how are you?"
    â†“
Gemini processes: 50 tokens input, 30 tokens output
    â†“
Cost: 50 * $0.35 / 1M = $0.0000175
      30 * $1.05 / 1M = $0.0000315
    â†“
Total: $0.000049 (~$0.00005) âœ… VERY CHEAP!
```

### Flow 2: Tool Call (Gemini â†’ OpenAI)

```
User: "Book appointment for tomorrow at 2pm"
    â†“
Gemini processes: 200 tokens input, 50 tokens output (detects tool)
Cost: $0.00009
    â†“
Switch to OpenAI
    â†“
OpenAI processes: 200 tokens input, 150 tokens output
  + 3 tool calls (get_customer_info, get_available_times, book_appointment)
  + Tool results: 300 tokens
Cost: $0.0015
    â†“
Total: $0.00009 + $0.0015 = $0.00159 (~$0.0016) âœ… STILL CHEAP!
```

### Flow 3: OpenAI Only (Traditional)

```
User: "Hello, how are you?"
    â†“
OpenAI processes: 50 tokens input, 30 tokens output
    â†“
Cost: 50 * $2.50 / 1M = $0.000125
      30 * $10 / 1M = $0.0003
    â†“
Total: $0.000425 (~$0.00043) âŒ 8.6x MORE EXPENSIVE!
```

## Provider Distribution (Typical Usage)

Based on 1000 messages per day:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MESSAGE TYPE DISTRIBUTION                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TEXT ONLY (70%)                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â”œâ”€ Greetings                    â”‚ 700 msgs/day
â”œâ”€ Questions                    â”‚ Gemini only
â”œâ”€ Follow-ups                   â”‚ Cost: $0.03/day
â””â”€ Acknowledgments              â”‚
                                â”‚
TOOL CALLS (30%)                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â”œâ”€ Bookings                     â”‚ 300 msgs/day
â”œâ”€ Cancellations                â”‚ Gemini â†’ OpenAI switch
â”œâ”€ Service inquiries            â”‚ Cost: $0.48/day
â””â”€ Pet management               â”‚

TOTAL DAILY COST (HYBRID):      $0.51/day = $15.30/month
TOTAL DAILY COST (OPENAI):      $1.25/day = $37.50/month

SAVINGS: $22.20/month (59% reduction) ğŸ’°
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              GEMINI ERROR HANDLING                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Message
    â†“
Gemini Agent
    â†“
    â”œâ”€ Success â†’ Return response âœ…
    â”‚
    â””â”€ Error â†’ Check error type
               â”‚
               â”œâ”€ API Key Invalid
               â”œâ”€ Rate Limit
               â”œâ”€ Network Error
               â””â”€ Internal Error
                    â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ AUTOMATIC FALLBACK â”‚
           â”‚ TO OPENAI          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
           OpenAI Agent (Retry)
                    â”‚
                    â”œâ”€ Success â†’ Return response âœ…
                    â”‚
                    â””â”€ Error â†’ Return error message âŒ
                               "I'm having trouble..."
```

## Configuration Impact

### Config: USE_LANGGRAPH=false

```
All messages â†’ Legacy OpenAI (no hybrid, no Gemini)
```

### Config: USE_LANGGRAPH=true, USE_GEMINI=false

```
All messages â†’ OpenAI Agent (LangGraph, no Gemini)
```

### Config: USE_LANGGRAPH=true, USE_GEMINI=true

```
Text messages â†’ Gemini Agent âœ…
Tool messages â†’ OpenAI Agent âœ…
(HYBRID MODE - RECOMMENDED)
```

## Real Example from Logs

### Successful Hybrid Flow:

```
19:57:56 [LangGraph] Using GEMINI as AI provider
19:57:56 [gemini-agent-node] Processing with 20 messages
19:57:56 [gemini-tool-calls-detected] Gemini detected 2 tool calls
19:57:56 [gemini-to-openai-switch] Switching to OpenAI for tools
19:57:56 [agent-node] Processing with 20 messages
19:58:19 [agent-response] Received text response
```

**Result:** Started with Gemini, switched to OpenAI for tools âœ…

---

**Last Updated:** 2025-01-04
**Diagram Version:** 1.0
